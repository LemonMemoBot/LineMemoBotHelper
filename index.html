<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>ç­†è¨˜å°å¹«æ‰‹</title>
    <meta name="description" content="LINE ç­†è¨˜å°å¹«æ‰‹ - ç”¨æ¨™ç±¤ç®¡ç†ä½ çš„éˆæ„Ÿèˆ‡ç¶²å€" />

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <!-- Google Fonts & Material Symbols -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* ==============================
       CSS è®Šæ•¸ & å…¨åŸŸé‡è¨­
    ============================== */
        .material-symbols-outlined {
            vertical-align: middle;
            font-size: 1.2rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        :root {
            --brand: #1E3A8A;
            /* åŸæœ¬çš„æ·ºè—æ”¹æ·±è— (Tailwind blue-900) */
            --brand-dark: #172554;
            --brand-light: #EFF6FF;
            --success: #27AE60;
            --bg: #F0F4F8;
            --surface: #FFFFFF;
            --text-1: #1A202C;
            --text-2: #4A5568;
            --text-3: #A0AEC0;
            --border: #E2E8F0;
            --radius-sm: 8px;
            --radius-md: 14px;
            --radius-lg: 20px;
            --shadow-sm: 0 2px 8px rgba(74, 144, 217, .12);
            --shadow-md: 0 6px 24px rgba(74, 144, 217, .18);
            --transition: .2s ease;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans TC', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-1);
            min-height: 100dvh;
            padding-bottom: calc(16px + var(--safe-bottom));
            -webkit-font-smoothing: antialiased;
        }

        /* ==============================
       é ‚éƒ¨ Header
    ============================== */
        .app-header {
            background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
            color: #fff;
            padding: calc(16px + var(--safe-top)) 20px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .app-header h1 {
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: .02em;
        }

        .app-header .subtitle {
            font-size: .75rem;
            opacity: .8;
            margin-top: 2px;
        }

        /* ==============================
       æœå°‹æ¬„
    ============================== */
        .search-bar {
            padding: 14px 16px 0;
        }

        .search-input-wrap {
            display: flex;
            align-items: center;
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1.5px solid var(--border);
            padding: 10px 16px;
            gap: 10px;
            transition: border-color var(--transition), box-shadow var(--transition);
        }

        .search-input-wrap:focus-within {
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(74, 144, 217, .15);
        }

        .search-icon {
            font-size: 1rem;
            color: var(--text-3);
            flex-shrink: 0;
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            /* é¿å… iOS è‡ªå‹•ç¸®æ”¾ */
            font-family: inherit;
            color: var(--text-1);
            background: transparent;
        }

        .search-input::placeholder {
            color: var(--text-3);
        }

        .search-clear {
            cursor: pointer;
            color: var(--text-3);
            user-select: none;
            transition: color var(--transition);
        }

        .search-clear:hover {
            color: var(--text-1);
        }

        /* ==============================
       ä¸»åˆ†é¡ Tab åˆ—ï¼ˆæ©«å‘æ²å‹•ï¼‰
    ============================== */
        .main-tabs {
            display: flex;
            gap: 8px;
            padding: 14px 16px 0;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .main-tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            flex-shrink: 0;
            padding: 7px 18px;
            border-radius: 999px;
            border: 1.5px solid var(--border);
            background: var(--surface);
            color: var(--text-2);
            font-size: .82rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            white-space: nowrap;
            font-family: inherit;
        }

        .tab-btn.active {
            background: var(--brand);
            border-color: var(--brand);
            color: #fff;
            box-shadow: var(--shadow-sm);
        }

        .tab-btn:hover:not(.active) {
            border-color: var(--brand);
            color: var(--brand);
            background: var(--brand-light);
        }

        /* ==============================
       å­åˆ†é¡ Tab åˆ—
    ============================== */
        .sub-tabs {
            display: flex;
            gap: 6px;
            padding: 10px 16px 0;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .sub-tabs::-webkit-scrollbar {
            display: none;
        }

        .sub-tab-btn {
            flex-shrink: 0;
            padding: 5px 14px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-3);
            font-size: .75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            font-family: inherit;
        }

        .sub-tab-btn.active {
            background: var(--brand-light);
            border-color: var(--brand);
            color: var(--brand);
        }

        /* ==============================
       Notes çµ±è¨ˆåˆ—
    ============================== */
        .notes-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 18px 4px;
        }

        .notes-count {
            font-size: .75rem;
            color: var(--text-3);
        }

        /* ==============================
       Card å®¹å™¨
    ============================== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 12px 16px 24px;
        }

        /* ==============================
       Note Card
    ============================== */
        .note-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: transform var(--transition), box-shadow var(--transition);
            animation: cardIn .25s ease both;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            position: relative;
            /* ä¾›å³ä¸Šè§’åˆªé™¤æŒ‰éˆ•å®šä½ */
        }

        @keyframes cardIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* ç¶²å€é è¦½åœ– */
        .card-og-wrap {
            width: 100%;
            aspect-ratio: 4 / 3;
            background: #f8f9fa;
            position: relative;
            overflow: hidden;
        }

        .card-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .card-thumbnail-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--brand-light) 0%, #dbeafe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--brand);
        }

        .card-body {
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 8px;
        }

        .card-title {
            font-size: 0.85rem;
            font-weight: 500;
            line-height: 1.4;
            color: var(--text-1);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            word-break: break-all;
        }

        .card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: auto;
        }

        .card-date {
            font-size: 0.7rem;
            color: var(--text-3);
        }

        .card-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-delete {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            color: var(--text-3);
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 6px;
            right: 6px;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-delete .material-symbols-outlined {
            font-size: 1.1rem;
        }

        .btn-delete:hover {
            color: #E53E3E;
            background: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .tag-chip.main {
            font-size: 0.65rem;
            color: var(--brand);
            border: 1px solid var(--brand);
            padding: 1px 6px;
            border-radius: 4px;
            background: var(--brand-light);
            white-space: nowrap;
        }

        /* ==============================
       ç©ºç‹€æ…‹
    ============================== */
        .empty-state {
            text-align: center;
            padding: 60px 20px 40px;
            color: var(--text-3);
        }

        .empty-state .emoji {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 1rem;
            color: var(--text-2);
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: .82rem;
            line-height: 1.6;
        }

        /* ==============================
       Loading ç‹€æ…‹
    ============================== */
        .loading-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 16px;
        }

        .spinner {
            width: 42px;
            height: 42px;
            border: 3.5px solid var(--brand-light);
            border-top-color: var(--brand);
            border-radius: 50%;
            animation: spin .8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: .85rem;
            color: var(--text-3);
        }

        /* ==============================
       éŒ¯èª¤æç¤º
    ============================== */
        .error-wrap {
            text-align: center;
            padding: 60px 20px;
        }

        .error-wrap .emoji {
            font-size: 2.5rem;
        }

        .error-wrap p {
            font-size: .85rem;
            color: var(--text-2);
            margin-top: 12px;
        }

        /* ==============================
       åº•éƒ¨å®‰å…¨å€ä½”ä½
    ============================== */
        .bottom-safe {
            height: var(--safe-bottom);
        }
    </style>
</head>

<body>
    <div id="app">

        <!-- è¼‰å…¥ä¸­ -->
        <div v-if="state === 'loading'" class="loading-wrap">
            <div class="spinner"></div>
            <p class="loading-text">è¼‰å…¥ç­†è¨˜ä¸­â€¦</p>
        </div>

        <!-- éŒ¯èª¤ -->
        <div v-else-if="state === 'error'" class="error-wrap">
            <div class="emoji">âš ï¸</div>
            <p>{{ errorMsg }}</p>
        </div>

        <!-- ä¸»ç•«é¢ -->
        <template v-else>
            <!-- Header -->
            <header class="app-header">
                <h1 style="display: flex; align-items: center; gap: 6px;">
                    <span class="material-symbols-outlined" style="font-size: 1.5rem;">edit_note</span>
                    ç­†è¨˜å°å¹«æ‰‹
                </h1>
                <p class="subtitle">{{ userDisplayName }} çš„ç­†è¨˜åº« Â· å…± {{ allNotes.length }} å‰‡</p>
            </header>

            <!-- æœå°‹æ¬„ -->
            <div class="search-bar">
                <div class="search-input-wrap">
                    <span class="search-icon material-symbols-outlined">search</span>
                    <input v-model="searchQuery" class="search-input" type="text" placeholder="æœå°‹ç­†è¨˜å…§å®¹æˆ–æ¨™ç±¤â€¦"
                        inputmode="search" />
                    <span v-if="searchQuery" class="search-clear material-symbols-outlined"
                        @click="searchQuery = ''">close</span>
                </div>
            </div>

            <!-- æœå°‹æ¨¡å¼ï¼šä¸é¡¯ç¤º Tabï¼Œç›´æ¥é¡¯ç¤ºçµæœ -->
            <template v-if="searchQuery.trim()">
                <div class="notes-meta">
                    <span class="notes-count">æœå°‹ã€Œ{{ searchQuery }}ã€Â· {{ filteredBySearch.length }} ç­†</span>
                </div>
                <div class="cards-grid">
                    <note-card v-for="note in filteredBySearch" :key="note.noteId" :note="note"
                        @delete-note="onDeleteNote"></note-card>
                    <div v-if="filteredBySearch.length === 0" class="empty-state">
                        <span class="material-symbols-outlined emoji"
                            style="font-size: 3rem; color: var(--text-3);">search_off</span>
                        <h3>æ‰¾ä¸åˆ°ç›¸é—œç­†è¨˜</h3>
                        <p>è©¦è©¦å…¶ä»–é—œéµå­—</p>
                    </div>
                </div>
            </template>

            <!-- æ­£å¸¸ç€è¦½æ¨¡å¼ -->
            <template v-else>
                <!-- ä¸»åˆ†é¡ Tab -->
                <div class="main-tabs" role="tablist">
                    <button v-for="tag in mainTags" :key="tag" class="tab-btn" :class="{ active: activeMain === tag }"
                        role="tab" :aria-selected="activeMain === tag" @click="selectMain(tag)">
                        #{{ tag }}
                    </button>
                </div>

                <!-- å­åˆ†é¡ Tab -->
                <div class="sub-tabs" v-if="subTags.length > 1" role="tablist">
                    <button v-for="sub in subTags" :key="sub" class="sub-tab-btn" :class="{ active: activeSub === sub }"
                        role="tab" @click="activeSub = sub">
                        {{ sub }}
                    </button>
                </div>

                <!-- ç­†è¨˜æ¸…å–® -->
                <div class="notes-meta">
                    <span class="notes-count">{{ displayedNotes.length }} å‰‡ç­†è¨˜</span>
                </div>

                <div class="cards-grid">
                    <note-card v-for="note in displayedNotes" :key="note.noteId" :note="note"
                        @delete-note="onDeleteNote"></note-card>

                    <div v-if="displayedNotes.length === 0" class="empty-state">
                        <span class="material-symbols-outlined emoji"
                            style="font-size: 3rem; color: var(--brand);">inbox</span>
                        <h3>é€™å€‹åˆ†é¡é‚„æ²’æœ‰ç­†è¨˜</h3>
                        <p>åœ¨ LINE èŠå¤©å®¤ä¸­è¼¸å…¥<br /><strong>#{{ activeMain }} å…§å®¹</strong><br />å³å¯æ–°å¢ç­†è¨˜</p>
                    </div>
                </div>
            </template>

            <div class="bottom-safe"></div>
        </template>
    </div>

    <!-- NoteCard å…ƒä»¶æ¨¡æ¿ -->
    <script type="text/x-template" id="note-card-tpl">
    <a :href="note.urls && note.urls[0] ? note.urls[0] : '#'" target="_blank" @click="handleCardClick($event)" class="note-card">
      
      <!-- çµ•å°å®šä½çš„åˆªé™¤æŒ‰éˆ• (å³ä¸Šè§’) -->
      <button class="btn-delete" @click.stop.prevent="confirmDelete" title="åˆªé™¤ç­†è¨˜">
          <span class="material-symbols-outlined">delete</span>
      </button>

      <!-- OG åœ–ç‰‡é è¦½ï¼ˆå¦‚æœæœ‰ç¶²å€å‰‡é¡¯ç¤ºï¼‰ -->
      <div v-if="note.urls && note.urls[0]" class="card-og-wrap">
        <img
          v-if="ogImage"
          :src="ogImage"
          class="card-thumbnail"
          :alt="note.content || note.mainTag"
          loading="lazy"
          @error="ogImage = ''"
        />
        <div v-else class="card-thumbnail-placeholder">
          <span class="material-symbols-outlined" style="font-size: 2.5rem;">link</span>
        </div>
      </div>

      <div class="card-body">
        <!-- å…§å®¹æ–‡å­— / æ¨™é¡Œ -->
        <h3 class="card-title">{{ note.content || note.subTag || note.mainTag }}</h3>

        <!-- åº•éƒ¨è³‡è¨Šèˆ‡æŒ‰éˆ• -->
        <div class="card-footer">
          <!-- å»ºç«‹æ—¥æœŸ -->
          <div class="card-date">
            <div style="font-size: 0.65rem; color: #888; margin-bottom: 2px;">{{ extractDateInfo(note.createdAt, 'date') }}</div>
            <div style="font-size: 0.65rem; color: #888;">{{ extractDateInfo(note.createdAt, 'time') }}</div>
          </div>
          
          <!-- å³å´ Tag -->
          <div class="card-actions">
            <span class="tag-chip main">{{ note.mainTag }}</span>
          </div>
        </div>
      </div>
    </a>
  </script>

    <script>
        // ============================================================
        // è¨­å®šå€ï¼ˆè«‹ä¿®æ”¹ç‚ºä½ è‡ªå·±çš„å€¼ï¼‰
        // ============================================================
        const LIFF_ID = '2009210185-wvVU27v3';            // ä¾‹å¦‚ï¼š1234567890-abcDEFgh
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxcMVBW4pHl87rf27BCMgbDWHN98T1Z4oiiM7H4z0hvk0gL7wAfQKVN1Ih9W2_VChHw/exec';    // éƒ¨ç½²å¾Œçš„ GAS ç¶²å€

        // ============================================================
        // NoteCard å­å…ƒä»¶
        // ============================================================
        const NoteCard = {
            name: 'NoteCard',
            template: '#note-card-tpl',
            props: {
                note: { type: Object, required: true }
            },
            data() {
                return { ogImage: null };
            },
            emits: ['delete-note'],
            mounted() {
                if (this.note.urls && this.note.urls[0]) {
                    this.loadOgImage(this.note.urls[0]);
                }
            },
            methods: {
                /**
                 * åˆ©ç”¨ microlink.io API å–å¾— OG é è¦½åœ–
                 * å…è²»æ–¹æ¡ˆæ¯æœˆ 1000 æ¬¡ï¼Œè¶³å¤ å€‹äººä½¿ç”¨
                 */
                async loadOgImage(url) {
                    try {
                        const api = `https://api.microlink.io?url=${encodeURIComponent(url)}&meta=false&screenshot=false`;
                        const res = await fetch(api);
                        const data = await res.json();
                        if (data.status === 'success' && data.data.image?.url) {
                            this.ogImage = data.data.image.url;
                        }
                    } catch (e) {
                        // å–å¾—å¤±æ•—å‰‡é¡¯ç¤ºé è¨­ iconï¼Œä¸å½±éŸ¿åŠŸèƒ½
                    }
                },

                extractDateInfo(isoStr, type) {
                    try {
                        const d = new Date(isoStr);
                        if (type === 'date') {
                            return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
                        } else {
                            return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                        }
                    } catch {
                        return '';
                    }
                },

                handleCardClick(event) {
                    if (!this.note.urls || this.note.urls.length === 0) {
                        event.preventDefault(); // æ²’æœ‰é€£çµå°±ä¸è·³è½‰
                    }
                },

                confirmDelete() {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç­†è¨˜å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚')) {
                        this.$emit('delete-note', this.note.noteId);
                    }
                }
            }
        };

        // ============================================================
        // Vue 3 ä¸»æ‡‰ç”¨ç¨‹å¼
        // ============================================================
        const { createApp, ref, computed, onMounted, watch } = Vue;

        const app = createApp({
            components: { NoteCard },

            setup() {
                // --- ç‹€æ…‹ ---
                const state = ref('loading');   // 'loading' | 'ready' | 'error'
                const errorMsg = ref('');
                const userDisplayName = ref('ä½ ');
                const allNotes = ref([]);           // ç•¶å‰ä½¿ç”¨è€…å…¨éƒ¨ç­†è¨˜

                // --- Tab ç‹€æ…‹ ---
                const activeMain = ref('');
                const activeSub = ref('');

                // --- æœå°‹ ---
                const searchQuery = ref('');

                // â”€â”€ ä¸»åˆ†é¡æ¸…å–® â”€â”€
                const mainTags = computed(() => {
                    return [...new Set(allNotes.value.map(n => n.mainTag))].sort();
                });

                // â”€â”€ å­åˆ†é¡æ¸…å–®ï¼ˆæ ¹æ“šé¸å–çš„ä¸»åˆ†é¡ï¼‰ â”€â”€
                const subTags = computed(() => {
                    const source = activeMain.value ? allNotes.value.filter(n => n.mainTag === activeMain.value) : allNotes.value;
                    return [...new Set(source.map(n => n.subTag))].sort();
                });

                // â”€â”€ é¡¯ç¤ºçš„ç­†è¨˜ï¼ˆæŒ‰ä¸»/å­ Tab éæ¿¾ï¼‰ â”€â”€
                const displayedNotes = computed(() => {
                    let notes = allNotes.value;
                    if (activeMain.value) {
                        notes = notes.filter(n => n.mainTag === activeMain.value);
                    }
                    if (activeSub.value) {
                        notes = notes.filter(n => n.subTag === activeSub.value);
                    }
                    // æœ€æ–°åœ¨å‰
                    return notes.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                });

                // è‡ªå‹•é è¨­é¸é …æˆ–åˆªé™¤ç©ºåˆ†é¡æ™‚è‡ªå‹•è·³è½‰çš„ç›£è½æ©Ÿåˆ¶
                watch(mainTags, (newTags) => {
                    if (newTags.length > 0 && (!activeMain.value || !newTags.includes(activeMain.value))) {
                        activeMain.value = newTags[0];
                    } else if (newTags.length === 0) {
                        activeMain.value = '';
                    }
                }, { immediate: true });

                watch(subTags, (newSubs) => {
                    if (newSubs.length > 0 && (!activeSub.value || !newSubs.includes(activeSub.value))) {
                        activeSub.value = newSubs[0];
                    } else if (newSubs.length === 0) {
                        activeSub.value = '';
                    }
                }, { immediate: true });

                // â”€â”€ æœå°‹éæ¿¾ï¼ˆå…¨æ–‡æ¯”å°ï¼‰ â”€â”€
                const filteredBySearch = computed(() => {
                    const kw = searchQuery.value.trim().toLowerCase();
                    if (!kw) return allNotes.value;
                    return allNotes.value.filter(n =>
                        n.mainTag.toLowerCase().includes(kw) ||
                        n.subTag.toLowerCase().includes(kw) ||
                        n.content.toLowerCase().includes(kw) ||
                        (n.urls || []).some(u => u.toLowerCase().includes(kw))
                    );
                });

                // â”€â”€ åˆ‡æ›ä¸»åˆ†é¡æ™‚é‡ç½®å­åˆ†é¡ â”€â”€
                const selectMain = (tag) => {
                    activeMain.value = tag;
                    // watch(subTags) æœƒè‡ªå‹•è™•ç†é‡ç½®ï¼Œä¸ç”¨æ‰‹å‹•è¨­ç©º
                };

                // â”€â”€ æ–°å¢ï¼šå¾Œç«¯ API å‘¼å«å…±ç”¨å‡½å¼ (å®‰å…¨ POST å‚³è¼¸) â”€â”€
                const targetIdRef = ref('');
                const callApi = async (action, extraData = {}) => {
                    await liff.ready; // ç¢ºä¿ LIFF å®Œå…¨æº–å‚™å¥½
                    const liffToken = liff.getIDToken();

                    if (!liffToken) {
                        throw new Error("ç„¡æ³•å–å¾—å®‰å…¨æ†‘è­‰ (Token)ã€‚å¦‚æœä½ åœ¨å¤–éƒ¨ç€è¦½å™¨é–‹å•Ÿï¼Œè«‹ç¢ºä¿ä½ å·²ç™»å…¥ LINEã€‚");
                    }

                    const payload = {
                        action,
                        liffToken,
                        // æ”¹ç”±å‰ç«¯å…ƒä»¶çµ±ä¸€æä¾›çš„ targetIdRef (å„ªå…ˆåƒç¶²å€åƒæ•¸ï¼Œå…¶æ¬¡ context) å‚³å›å¾Œç«¯
                        groupId: targetIdRef.value,
                        ...extraData
                    };

                    const res = await fetch(GAS_URL, {
                        method: 'POST',
                        // åˆ»æ„ä¸æŒ‡å®š Content-Type ä»¥é¿å…è§¸ç™¼ CORS Preflight (OPTIONS)ï¼Œè®“ GAS doPost èƒ½ç›´æ¥æ¥æ”¶
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) throw new Error(`HTTP éŒ¯èª¤ç¢¼ ${res.status}`);
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    return data;
                };

                // â”€â”€ åˆªé™¤ API å‘¼å«èˆ‡æœ¬åœ°ç‹€æ…‹æ›´æ–° â”€â”€
                const onDeleteNote = async (noteId) => {
                    // æ¨‚è§€æ›´æ–°ï¼šå…ˆå¾æœ¬åœ°ç§»é™¤ï¼Œè®“ç•«é¢ç¬é–“åˆ·æ–°
                    const originalNotes = [...allNotes.value];
                    allNotes.value = allNotes.value.filter(n => n.noteId !== noteId);

                    // åŒæ­¥æ›´æ–°æœ¬åœ°å¿«å–
                    const cacheKey = `notes_cache_${targetIdRef.value}`;
                    localStorage.setItem(cacheKey, JSON.stringify(allNotes.value));

                    try {
                        await callApi('delete', { noteId });
                    } catch (e) {
                        alert(`åˆªé™¤å¤±æ•—ï¼š${e.message}`);
                        // ç™¼ç”ŸéŒ¯èª¤å‰‡é‚„åŸæœ¬åœ°è³‡æ–™
                        allNotes.value = originalNotes;
                        localStorage.setItem(cacheKey, JSON.stringify(allNotes.value));
                    }
                };

                // â”€â”€ åˆå§‹åŒ– LIFF ä¸¦è¼‰å…¥è³‡æ–™ â”€â”€
                onMounted(async () => {
                    try {
                        await liff.init({ liffId: LIFF_ID });

                        if (!liff.isLoggedIn()) {
                            liff.login();
                            return;
                        }

                        // ğŸ’¡ æ ¸å¿ƒè§£æ³•ï¼šå„ªå…ˆå¾ç¶²å€åƒæ•¸å–å¾— ownerId (ç”±æ©Ÿå™¨äººå¸¶å…¥)
                        const urlParams = new URLSearchParams(window.location.search);
                        const paramOwnerId = urlParams.get('ownerId');

                        // å–å¾—ä½¿ç”¨è€…è³‡æ–™èˆ‡ç’°å¢ƒ (ä½œç‚ºå‚™æ¡ˆ)
                        const profile = await liff.getProfile();
                        const context = liff.getContext();

                        let targetId = '';
                        if (paramOwnerId) {
                            // å¦‚æœç¶²å€æœ‰å¸¶ï¼Œç›´æ¥ä¿¡ä»»ç¶²å€ (è§£æ±º Provider è„«é‰¤èˆ‡ Room éš±ç§å•é¡Œ)
                            targetId = paramOwnerId;
                            userDisplayName.value = targetId.startsWith('C') || targetId.startsWith('R') ? 'ç¾¤çµ„' : profile.displayName;
                        } else if (context && (context.type === 'group' || context.type === 'room')) {
                            // é€€å›èˆŠç‰ˆæ©Ÿåˆ¶ (è¬ä¸€ä½¿ç”¨è€…ä¸æ˜¯é€éæŒ‰éˆ•é»æ“Šé€²ä¾†)
                            targetId = context.groupId || context.roomId;
                            userDisplayName.value = 'ç¾¤çµ„';
                        } else {
                            targetId = profile.userId;
                            userDisplayName.value = profile.displayName;
                        }
                        targetIdRef.value = targetId;

                        // ğŸ’¡ æ•ˆèƒ½å„ªåŒ–ï¼šå…ˆå¾ localStorage é¡¯ç¤ºæš«å­˜å¿«å–ï¼Œè®“ç•«é¢ã€Œç§’é–‹ã€
                        const cacheKey = `notes_cache_${targetId}`;
                        const cachedData = localStorage.getItem(cacheKey);
                        if (cachedData) {
                            try {
                                allNotes.value = JSON.parse(cachedData);
                                state.value = 'ready'; // ç›´æ¥è§£é™¤ Loading ç‹€æ…‹
                            } catch (e) {
                                console.warn("å¿«å–è§£æå¤±æ•—", e);
                            }
                        }

                        // èƒŒæ™¯å‘¼å« GAS API å–å¾—æœ€æ–°ç­†è¨˜ (ä½¿ç”¨å®‰å…¨ POST + Token)
                        callApi('getNotes')
                            .then(data => {
                                allNotes.value = data.notes || [];

                                // æ›´æ–°å¿«å–
                                localStorage.setItem(cacheKey, JSON.stringify(data.notes));

                                // å¦‚æœåŸæœ¬æ²’å¿«å–ï¼Œç¾åœ¨æ‰è§£é–‹ Loading
                                if (state.value === 'loading') {
                                    state.value = 'ready';
                                }
                            })
                            .catch(err => {
                                // åªæœ‰åœ¨é€£å¿«å–éƒ½æ²’æœ‰çš„æƒ…æ³ä¸‹æ‰é¡¯ç¤ºéŒ¯èª¤
                                if (state.value === 'loading') {
                                    errorMsg.value = `è¼‰å…¥å¤±æ•—ï¼š${err.message}`;
                                    state.value = 'error';
                                }
                                console.error('GAS API æ‹‰å–éŒ¯èª¤:', err);
                            });

                    } catch (err) {
                        errorMsg.value = `åˆå§‹åŒ–å¤±æ•—ï¼š${err.message}`;
                        state.value = 'error';
                        console.error('LIFF åˆå§‹åŒ–éŒ¯èª¤:', err);
                    }
                });

                return {
                    state, errorMsg, userDisplayName,
                    allNotes, mainTags, subTags,
                    activeMain, activeSub,
                    displayedNotes, filteredBySearch,
                    searchQuery, selectMain,
                    onDeleteNote, targetIdRef
                };
            }
        });

        app.mount('#app');
    </script>
</body>

</html>
