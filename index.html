<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MemoBot | å¾®ç­†è¨˜åŠ©æ‰‹</title>
    <meta name="description" content="LINE ç­†è¨˜å°å¹«æ‰‹ - ç”¨æ¨™ç±¤ç®¡ç†ä½ çš„éˆæ„Ÿèˆ‡ç¶²å€" />

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <!-- Google Fonts & Material Symbols -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* ==============================
       CSS è®Šæ•¸ & å…¨åŸŸé‡è¨­
    ============================== */
        .material-symbols-outlined {
            vertical-align: middle;
            font-size: 1.2rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        :root {
            --brand: #1E3A8A;
            /* åŸæœ¬çš„æ·ºè—æ”¹æ·±è— (Tailwind blue-900) */
            --brand-dark: #172554;
            --brand-light: #EFF6FF;
            --success: #27AE60;
            --bg: #F0F4F8;
            --surface: #FFFFFF;
            --text-1: #1A202C;
            --text-2: #4A5568;
            --text-3: #A0AEC0;
            --border: #E2E8F0;
            --radius-sm: 8px;
            --radius-md: 14px;
            --radius-lg: 20px;
            --shadow-sm: 0 2px 8px rgba(74, 144, 217, .12);
            --shadow-md: 0 6px 24px rgba(74, 144, 217, .18);
            --transition: .2s ease;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            overflow-x: hidden;
            width: 100%;
            overscroll-behavior: none;
            /* é˜²æ­¢ Safari/Chrome ä¸Šä¸‹æ»‘å‹•éœ²å‡ºç©ºç™½ */
        }

        body {
            font-family: 'Noto Sans TC', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-1);
            min-height: 100dvh;
            padding-bottom: calc(16px + var(--safe-bottom));
            -webkit-font-smoothing: antialiased;
        }

        /* ==============================
       é ‚éƒ¨ Header
    ============================== */
        .app-header {
            background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
            color: #fff;
            padding: calc(16px + var(--safe-top)) 20px 14px;
            /* ç¸®å°ä¸€é»åº•éƒ¨ padding */
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .app-header h1 {
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: .02em;
        }

        .app-header .subtitle {
            font-size: .75rem;
            opacity: .8;
            margin-top: 2px;
        }

        /* ==============================
       æœå°‹æ¬„ (ç§»å…¥ Header å…§)
    ============================== */
        .search-bar {
            padding: 12px 0 0 0;
            /* ç¸®å°èˆ‡ä¸Šæ–¹æ¨™é¡Œçš„è·é›¢ */
            /* ç§»é™¤å·¦å³ paddingï¼Œå› ç‚º header å·²ç¶“æœ‰äº† */
        }

        .search-input-wrap {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.15);
            /* è®“ Header å…§çš„ Search æ›´åŠ ä½èª¿ */
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 6px 14px;
            /* ç¸®æ¸›é«˜åº¦å°ºå¯¸ */
            gap: 8px;
            transition: all var(--transition);
        }

        .search-input-wrap:focus-within {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(0, 0, 0, 0.25);
            box-shadow: none;
        }

        .search-icon {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.7);
            flex-shrink: 0;
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 14px;
            /* ç¸®å°å­—é«”ä»¥å…æ¶æˆ² */
            font-family: inherit;
            color: #fff;
            background: transparent;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-clear {
            cursor: pointer;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.7);
            user-select: none;
            transition: color var(--transition);
        }

        .search-clear:hover {
            color: #fff;
        }

        /* ==============================
       ä¸»åˆ†é¡ Tab åˆ—ï¼ˆæ©«å‘æ²å‹• + åº•ç·šé¢¨æ ¼ï¼‰
    ============================== */
        .main-tabs {
            display: flex;
            align-items: flex-end;
            /* ç©©å®šåº•éƒ¨åç§»é‡ï¼Œè§£æ±ºä¸Šä¸‹æ»‘å‹• */
            gap: 16px;
            /* å¢åŠ é–“è· */
            padding: 0 16px;
            /* ç§»é™¤ top padding */
            margin-top: 14px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            border-bottom: 1.5px solid var(--border);
            /* æ•´æ¢é è¨­åº•ç·š */
        }

        .main-tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            flex-shrink: 0;
            padding: 8px 4px;
            border: none;
            border-bottom: 2px solid transparent;
            /* é ç•™åº•ç·šç©ºé–“ */
            background: transparent;
            color: var(--text-2);
            font-size: .95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            white-space: nowrap;
            font-family: inherit;
            margin-bottom: -1.5px;
            /* è²¼ç·Šçˆ¶å±¤åº•ç·š */
        }

        .tab-btn.active {
            color: var(--brand);
            border-bottom-color: var(--brand);
            /* é¸ä¸­æ™‚äº®èµ·åº•ç·š */
        }

        .tab-btn:hover:not(.active) {
            color: var(--brand);
        }

        /* ==============================
       å­åˆ†é¡ Tab åˆ—
    ============================== */
        .sub-tabs {
            display: flex;
            gap: 6px;
            padding: 10px 16px 0;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .sub-tabs::-webkit-scrollbar {
            display: none;
        }

        .sub-tab-btn {
            flex-shrink: 0;
            padding: 5px 14px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-3);
            font-size: .75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            font-family: inherit;
        }

        .sub-tab-btn.active {
            background: var(--brand-light);
            border-color: var(--brand);
            color: var(--brand);
        }

        /* ==============================
       Notes çµ±è¨ˆåˆ—
    ============================== */
        .notes-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 18px 4px;
        }

        .notes-count {
            font-size: .75rem;
            color: var(--text-3);
        }

        /* ==============================
       Card å®¹å™¨
    ============================== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 12px 16px 24px;
        }

        /* ==============================
       Note Card
    ============================== */
        .note-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: transform var(--transition), box-shadow var(--transition);
            animation: cardIn .25s ease both;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            position: relative;
            /* ä¾›å³ä¸Šè§’åˆªé™¤æŒ‰éˆ•å®šä½ */
        }

        @keyframes cardIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* ç¶²å€é è¦½åœ– */
        .card-og-wrap {
            width: 100%;
            aspect-ratio: 4 / 3;
            background: #f8f9fa;
            position: relative;
            overflow: hidden;
        }

        .card-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .card-thumbnail-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--brand-light) 0%, #dbeafe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--brand);
        }

        .card-body {
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 8px;
        }

        .card-title {
            font-size: 0.85rem;
            font-weight: 500;
            line-height: 1.4;
            color: var(--text-1);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            word-break: break-all;
        }

        .card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: auto;
        }

        .card-date {
            font-size: 0.75rem;
            color: var(--text-3);
        }

        .btn-delete {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            color: var(--text-3);
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 6px;
            right: 6px;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-delete .material-symbols-outlined {
            font-size: 1.1rem;
        }

        .btn-delete:hover {
            color: #E53E3E;
            background: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .tag-chip.main {
            font-size: 0.65rem;
            color: var(--brand);
            border: 1px solid var(--brand);
            padding: 1px 6px;
            border-radius: 4px;
            background: var(--brand-light);
            white-space: nowrap;
        }

        /* ==============================
       ç©ºç‹€æ…‹
    ============================== */
        .empty-state {
            text-align: center;
            padding: 60px 20px 40px;
            color: var(--text-3);
        }

        .empty-state .emoji {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 1rem;
            color: var(--text-2);
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: .82rem;
            line-height: 1.6;
        }

        /* ==============================
       Loading ç‹€æ…‹
    ============================== */
        .loading-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 16px;
        }

        .spinner {
            width: 42px;
            height: 42px;
            border: 3.5px solid var(--brand-light);
            border-top-color: var(--brand);
            border-radius: 50%;
            animation: spin .8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: .85rem;
            color: var(--text-3);
        }

        /* ==============================
       éŒ¯èª¤æç¤º
    ============================== */
        .error-wrap {
            text-align: center;
            padding: 60px 20px;
        }

        .error-wrap .emoji {
            font-size: 2.5rem;
        }

        .error-wrap p {
            font-size: .85rem;
            color: var(--text-2);
            margin-top: 12px;
        }

        /* ==============================
       åº•éƒ¨å®‰å…¨å€ä½”ä½
    ============================== */
        .bottom-safe {
            height: var(--safe-bottom);
        }
    </style>
</head>

<body>
    <div id="app">

        <!-- è¼‰å…¥ä¸­ -->
        <div v-if="state === 'loading'" class="loading-wrap">
            <div class="spinner"></div>
            <p class="loading-text">è¼‰å…¥ç­†è¨˜ä¸­â€¦</p>
        </div>

        <!-- éŒ¯èª¤ -->
        <div v-else-if="state === 'error'" class="error-wrap">
            <div class="emoji">âš ï¸</div>
            <p>{{ errorMsg }}</p>
        </div>

        <!-- ä¸»ç•«é¢ -->
        <template v-else>
            <!-- Header (åŒ…å«æ¨™é¡Œèˆ‡å…¨åŸŸæœå°‹) -->
            <header class="app-header">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <h1 style="display: flex; align-items: center; gap: 6px;">
                        <span class="material-symbols-outlined" style="font-size: 1.5rem;">edit_note</span>
                        MemoBot | å¾®ç­†è¨˜åŠ©æ‰‹
                    </h1>
                    <!-- åŒæ­¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
                    <div v-if="isSyncing"
                        style="display: flex; align-items: center; gap: 4px; font-size: 0.75rem; color: rgba(255,255,255,0.8);">
                        <span class="material-symbols-outlined"
                            style="font-size: 1rem; animation: spin 1s linear infinite;">sync</span>
                        åŒæ­¥ä¸­
                    </div>
                </div>
                <p class="subtitle">{{ userDisplayName }} çš„ç­†è¨˜åº« Â· å…± {{ allNotes.length }} å‰‡</p>

                <!-- æŠŠå…¨åŸŸæœå°‹æ¬„ç§»åˆ°æ·±è‰² Header åº•ä¸‹ -->
                <div class="search-bar">
                    <div class="search-input-wrap">
                        <span class="search-icon material-symbols-outlined">search</span>
                        <input v-model="searchQuery" class="search-input" type="text" placeholder="æœå°‹å…¨ç«™ç­†è¨˜å…§å®¹æˆ–æ¨™ç±¤â€¦"
                            inputmode="search" />
                        <span v-if="searchQuery" class="search-clear material-symbols-outlined"
                            @click="searchQuery = ''">close</span>
                    </div>
                </div>
            </header>

            <!-- æœå°‹æ¨¡å¼ï¼šä¸é¡¯ç¤º Tabï¼Œç›´æ¥é¡¯ç¤ºçµæœ -->
            <template v-if="searchQuery.trim()">
                <div class="notes-meta">
                    <span class="notes-count">æœå°‹ã€Œ{{ searchQuery }}ã€Â· {{ filteredBySearch.length }} ç­†</span>
                </div>
                <div class="cards-grid">
                    <note-card v-for="note in filteredBySearch" :key="note.noteId" :note="note"
                        @delete-note="onDeleteNote"></note-card>
                    <div v-if="filteredBySearch.length === 0" class="empty-state">
                        <span class="material-symbols-outlined emoji"
                            style="font-size: 3rem; color: var(--text-3);">search_off</span>
                        <h3>æ‰¾ä¸åˆ°ç›¸é—œç­†è¨˜</h3>
                        <p>è©¦è©¦å…¶ä»–é—œéµå­—</p>
                    </div>
                </div>
            </template>

            <!-- æ­£å¸¸ç€è¦½æ¨¡å¼ -->
            <template v-else>
                <!-- ä¸»åˆ†é¡ Tab -->
                <div class="main-tabs" role="tablist">
                    <button v-for="tag in mainTags" :key="tag" class="tab-btn" :class="{ active: activeMain === tag }"
                        role="tab" :aria-selected="activeMain === tag" @click="selectMain(tag)">
                        {{ tag }}
                    </button>
                </div>

                <!-- å­åˆ†é¡ Tab -->
                <div class="sub-tabs" v-if="subTags.length > 1" role="tablist">
                    <button v-for="sub in subTags" :key="sub" class="sub-tab-btn" :class="{ active: activeSub === sub }"
                        role="tab" @click="activeSub = sub">
                        {{ sub }}
                    </button>
                </div>

                <!-- åˆ†é¡å…§éæ¿¾æœå°‹ (åœ¨ç¾æœ‰åˆ†é¡ä¸‹äºŒæ¬¡æœå°‹) -->
                <div class="sub-category-search" v-if="activeMain">
                    <div class="search-input-wrap"
                        style="padding: 8px 14px; margin: 12px 16px 0; border-radius: var(--radius-sm); border: 1px solid var(--border); box-shadow: none;">
                        <span class="search-icon material-symbols-outlined" style="font-size: 1.1rem;">filter_alt</span>
                        <input v-model="subSearchQuery" class="search-input" style="font-size: 15px;" type="text"
                            :placeholder="'åœ¨ ' + (activeSub || activeMain) + ' ä¸­æœå°‹...'" inputmode="search" />
                        <span v-if="subSearchQuery" class="search-clear material-symbols-outlined"
                            style="font-size: 1.2rem;" @click="subSearchQuery = ''">close</span>
                    </div>
                </div>

                <!-- ç­†è¨˜æ¸…å–® -->
                <div class="notes-meta">
                    <span class="notes-count" v-if="subSearchQuery">åŒ…å«ã€Œ{{ subSearchQuery }}ã€å…± {{ displayedNotes.length
                        }} å‰‡</span>
                    <span class="notes-count" v-else>{{ displayedNotes.length }} å‰‡ç­†è¨˜</span>
                </div>

                <div class="cards-grid">
                    <note-card v-for="note in displayedNotes" :key="note.noteId" :note="note"
                        @delete-note="onDeleteNote"></note-card>

                    <div v-if="displayedNotes.length === 0" class="empty-state">
                        <template v-if="subSearchQuery">
                            <span class="material-symbols-outlined emoji"
                                style="font-size: 3rem; color: var(--text-3);">search_off</span>
                            <h3>æ‰¾ä¸åˆ°ç¬¦åˆã€Œ{{subSearchQuery}}ã€çš„ç­†è¨˜</h3>
                            <p>è©¦è‘—æ¸…é™¤éæ¿¾æ¢ä»¶</p>
                        </template>
                        <template v-else>
                            <span class="material-symbols-outlined emoji"
                                style="font-size: 3rem; color: var(--brand);">inbox</span>
                            <h3>é€™å€‹åˆ†é¡é‚„æ²’æœ‰ç­†è¨˜</h3>
                            <p>åœ¨ LINE èŠå¤©å®¤ä¸­è¼¸å…¥<br /><strong>#{{ activeMain }} å…§å®¹</strong><br />å³å¯æ–°å¢ç­†è¨˜</p>
                        </template>
                    </div>
                </div>
            </template>

            <div class="bottom-safe"></div>
        </template>
    </div>

    <!-- NoteCard å…ƒä»¶æ¨¡æ¿ -->
    <script type="text/x-template" id="note-card-tpl">
    <a :href="note.urls && note.urls[0] ? note.urls[0] : '#'" target="_blank" @click="handleCardClick($event)" class="note-card">
      
      <!-- çµ•å°å®šä½çš„åˆªé™¤æŒ‰éˆ• (å³ä¸Šè§’) -->
      <button class="btn-delete" @click.stop.prevent="confirmDelete" title="åˆªé™¤ç­†è¨˜">
          <span class="material-symbols-outlined">delete</span>
      </button>

      <!-- OG åœ–ç‰‡é è¦½ï¼ˆå¦‚æœæœ‰ç¶²å€å‰‡é¡¯ç¤ºï¼‰ -->
      <div v-if="note.urls && note.urls[0]" class="card-og-wrap">
        <img
          v-if="ogImage"
          :src="ogImage"
          class="card-thumbnail"
          :alt="note.content || note.mainTag"
          loading="lazy"
          @error="ogImage = ''"
        />
        <div v-else class="card-thumbnail-placeholder">
          <span class="material-symbols-outlined" style="font-size: 2.5rem;">link</span>
        </div>
      </div>

      <div class="card-body">
        <!-- å…§å®¹æ–‡å­— / æ¨™é¡Œ (å°‡åŒ…å«ç¶²å€çš„åœ°æ–¹è½‰ç‚ºå¯é»æ“Šè¶…é€£çµ) -->
        <div class="card-title" v-html="formatContent(note.content) || (note.subTag || note.mainTag)"></div>

        <!-- åº•éƒ¨è³‡è¨Šèˆ‡æŒ‰éˆ• -->
        <div class="card-footer">
          <!-- å»ºç«‹æ—¥æœŸ (å°‡æ—¥æœŸèˆ‡æ™‚é–“ä½µç‚ºä¸€åˆ—) -->
          <div class="card-date">
            {{ extractDateInfo(note.createdAt, 'date') }} {{ extractDateInfo(note.createdAt, 'time') }}
          </div>
        </div>
      </div>
    </a>
  </script>

    <script>
        // ============================================================
        // è¨­å®šå€ï¼ˆè«‹ä¿®æ”¹ç‚ºä½ è‡ªå·±çš„å€¼ï¼‰
        // ============================================================
        const LIFF_ID = '2009210185-wvVU27v3';            // ä¾‹å¦‚ï¼š1234567890-abcDEFgh
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxcMVBW4pHl87rf27BCMgbDWHN98T1Z4oiiM7H4z0hvk0gL7wAfQKVN1Ih9W2_VChHw/exec';    // éƒ¨ç½²å¾Œçš„ GAS ç¶²å€

        // ============================================================
        // NoteCard å­å…ƒä»¶
        // ============================================================
        const NoteCard = {
            name: 'NoteCard',
            template: '#note-card-tpl',
            props: {
                note: { type: Object, required: true }
            },
            data() {
                return { ogImage: null };
            },
            emits: ['delete-note'],
            mounted() {
                if (this.note.urls && this.note.urls[0]) {
                    this.loadOgImage(this.note.urls[0]);
                }
            },
            methods: {
                /**
                 * åˆ©ç”¨ microlink.io API å–å¾— OG é è¦½åœ–
                 * å…è²»æ–¹æ¡ˆæ¯æœˆ 1000 æ¬¡ï¼Œè¶³å¤ å€‹äººä½¿ç”¨
                 */
                async loadOgImage(url) {
                    try {
                        const api = `https://api.microlink.io?url=${encodeURIComponent(url)}&meta=false&screenshot=false`;
                        const res = await fetch(api);
                        const data = await res.json();
                        if (data.status === 'success' && data.data.image?.url) {
                            this.ogImage = data.data.image.url;
                        }
                    } catch (e) {
                        // å–å¾—å¤±æ•—å‰‡é¡¯ç¤ºé è¨­ iconï¼Œä¸å½±éŸ¿åŠŸèƒ½
                    }
                },

                extractDateInfo(isoStr, type) {
                    try {
                        const d = new Date(isoStr);
                        if (type === 'date') {
                            return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
                        } else {
                            return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                        }
                    } catch {
                        return '';
                    }
                },

                // è¾¨è­˜æ–‡å­—ä¸­çš„ URL ä¸¦æ›¿æ›æˆ <a> (åœç”¨å†’æ³¡ä»¥æ”¯æ´ç¨ç«‹é»æ“Š)
                formatContent(text) {
                    if (!text) return '';

                    // ç‚ºäº†å®‰å…¨ï¼Œç°¡æ˜“é€ƒè„« HTML
                    let safeText = text.replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");

                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    return safeText.replace(urlRegex, function (url) {
                        return `<a href="${url}" target="_blank" style="color: var(--brand); text-decoration: underline;" @click.stop>${url}</a>`;
                    });
                },

                handleCardClick(event) {
                    if (!this.note.urls || this.note.urls.length === 0) {
                        event.preventDefault(); // æ²’æœ‰é€£çµå°±ä¸è·³è½‰
                    }
                },

                confirmDelete() {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç­†è¨˜å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚')) {
                        this.$emit('delete-note', this.note.noteId);
                    }
                }
            }
        };

        // ============================================================
        // Vue 3 ä¸»æ‡‰ç”¨ç¨‹å¼
        // ============================================================
        const { createApp, ref, computed, onMounted, watch } = Vue;

        const app = createApp({
            components: { NoteCard },

            setup() {
                // --- ç‹€æ…‹ ---
                const state = ref('loading');   // 'loading' | 'ready' | 'error'
                const errorMsg = ref('');
                const userDisplayName = ref('ä½ ');
                const allNotes = ref([]);           // ç•¶å‰ä½¿ç”¨è€…å…¨éƒ¨ç­†è¨˜
                const isSyncing = ref(false);       // æ˜¯å¦æ­£åœ¨èƒŒæ™¯åŒæ­¥è³‡æ–™
                let fetchVersion = 0;               // ç”¨æ–¼é˜²æ­¢ API å›å‚³é †åºéŒ¯äº‚ (Race Condition)

                // --- Tab ç‹€æ…‹ ---
                const activeMain = ref('');
                const activeSub = ref('');

                // --- æœå°‹ ---
                const searchQuery = ref('');
                const subSearchQuery = ref(''); // åˆ†é¡å…§äºŒæ¬¡æœå°‹

                // â”€â”€ ä¸»åˆ†é¡æ¸…å–® â”€â”€
                const mainTags = computed(() => {
                    return [...new Set(allNotes.value.map(n => n.mainTag))].sort();
                });

                // â”€â”€ å­åˆ†é¡æ¸…å–®ï¼ˆæ ¹æ“šé¸å–çš„ä¸»åˆ†é¡ï¼‰ â”€â”€
                const subTags = computed(() => {
                    const source = activeMain.value ? allNotes.value.filter(n => n.mainTag === activeMain.value) : allNotes.value;
                    return [...new Set(source.map(n => n.subTag))].sort();
                });

                // â”€â”€ é¡¯ç¤ºçš„ç­†è¨˜ï¼ˆæŒ‰ä¸»/å­ Tab èˆ‡åˆ†é¡å…§éæ¿¾ï¼‰ â”€â”€
                const displayedNotes = computed(() => {
                    let notes = allNotes.value;
                    if (activeMain.value) {
                        notes = notes.filter(n => n.mainTag === activeMain.value);
                    }
                    if (activeSub.value) {
                        notes = notes.filter(n => n.subTag === activeSub.value);
                    }
                    // åˆ†é¡å…§çš„äºŒæ¬¡æœå°‹
                    const sw = subSearchQuery.value.trim().toLowerCase();
                    if (sw) {
                        notes = notes.filter(n =>
                            n.mainTag.toLowerCase().includes(sw) ||
                            n.subTag.toLowerCase().includes(sw) ||
                            n.content.toLowerCase().includes(sw) ||
                            (n.urls || []).some(u => u.toLowerCase().includes(sw))
                        );
                    }
                    // æœ€æ–°åœ¨å‰
                    return notes.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                });

                // è‡ªå‹•é è¨­é¸é …æˆ–åˆªé™¤ç©ºåˆ†é¡æ™‚è‡ªå‹•è·³è½‰çš„ç›£è½æ©Ÿåˆ¶
                watch(mainTags, (newTags) => {
                    if (newTags.length > 0 && (!activeMain.value || !newTags.includes(activeMain.value))) {
                        activeMain.value = newTags[0];
                    } else if (newTags.length === 0) {
                        activeMain.value = '';
                    }
                }, { immediate: true });

                watch(subTags, (newSubs) => {
                    if (newSubs.length > 0 && (!activeSub.value || !newSubs.includes(activeSub.value))) {
                        activeSub.value = newSubs[0];
                    } else if (newSubs.length === 0) {
                        activeSub.value = '';
                    }
                }, { immediate: true });

                // åˆ‡æ›ä¸»åˆ†é¡æˆ–å­åˆ†é¡æ™‚ï¼Œæ¸…ç©ºç•¶ä¸‹çš„äºŒæ¬¡æœå°‹æ¡†
                watch([activeMain, activeSub], () => {
                    subSearchQuery.value = '';
                });

                // â”€â”€ æœå°‹éæ¿¾ï¼ˆå…¨æ–‡æ¯”å°ï¼‰ â”€â”€
                const filteredBySearch = computed(() => {
                    const kw = searchQuery.value.trim().toLowerCase();
                    if (!kw) return allNotes.value;
                    return allNotes.value.filter(n =>
                        n.mainTag.toLowerCase().includes(kw) ||
                        n.subTag.toLowerCase().includes(kw) ||
                        n.content.toLowerCase().includes(kw) ||
                        (n.urls || []).some(u => u.toLowerCase().includes(kw))
                    );
                });

                // â”€â”€ åˆ‡æ›ä¸»åˆ†é¡æ™‚é‡ç½®å­åˆ†é¡ â”€â”€
                const selectMain = (tag) => {
                    activeMain.value = tag;
                    // watch(subTags) æœƒè‡ªå‹•è™•ç†é‡ç½®ï¼Œä¸ç”¨æ‰‹å‹•è¨­ç©º
                };

                // â”€â”€ æ–°å¢ï¼šå¾Œç«¯ API å‘¼å«å…±ç”¨å‡½å¼ (å®‰å…¨ POST å‚³è¼¸) â”€â”€
                const targetIdRef = ref('');
                const callApi = async (action, extraData = {}) => {
                    await liff.ready; // ç¢ºä¿ LIFF å®Œå…¨æº–å‚™å¥½
                    const liffToken = liff.getIDToken();

                    if (!liffToken) {
                        throw new Error("ç„¡æ³•å–å¾—å®‰å…¨æ†‘è­‰ (Token)ã€‚å¦‚æœä½ åœ¨å¤–éƒ¨ç€è¦½å™¨é–‹å•Ÿï¼Œè«‹ç¢ºä¿ä½ å·²ç™»å…¥ LINEã€‚");
                    }

                    const payload = {
                        action,
                        liffToken,
                        // æ”¹ç”±å‰ç«¯å…ƒä»¶çµ±ä¸€æä¾›çš„ targetIdRef (å„ªå…ˆåƒç¶²å€åƒæ•¸ï¼Œå…¶æ¬¡ context) å‚³å›å¾Œç«¯
                        groupId: targetIdRef.value,
                        ...extraData
                    };

                    const res = await fetch(GAS_URL, {
                        method: 'POST',
                        // åˆ»æ„ä¸æŒ‡å®š Content-Type ä»¥é¿å…è§¸ç™¼ CORS Preflight (OPTIONS)ï¼Œè®“ GAS doPost èƒ½ç›´æ¥æ¥æ”¶
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) throw new Error(`HTTP éŒ¯èª¤ç¢¼ ${res.status}`);
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    return data;
                };

                // â”€â”€ åˆªé™¤ API å‘¼å«èˆ‡æœ¬åœ°ç‹€æ…‹æ›´æ–° â”€â”€
                const onDeleteNote = async (noteId) => {
                    fetchVersion++; // é˜»æ–·ä»»ä½•æ­£åœ¨èƒŒæ™¯æ’ˆå–èˆŠè³‡æ–™çš„è«‹æ±‚è¦†è“‹ç•«é¢
                    const originalNotes = [...allNotes.value];
                    allNotes.value = allNotes.value.filter(n => n.noteId !== noteId);

                    // åŒæ­¥å¯«å…¥å¿«å–ï¼Œè®“ä½¿ç”¨è€…æ„Ÿè¦ºç¬é–“åˆªé™¤
                    const cacheKey = `notes_cache_${targetIdRef.value}`;
                    localStorage.setItem(cacheKey, JSON.stringify(allNotes.value));

                    isSyncing.value = true;
                    try {
                        await callApi('delete', { noteId });
                        // ç¢ºä¿é ç«¯çœŸçš„åˆªé™¤å¾Œï¼Œå†æ¬¡å•Ÿå‹•èƒŒæ™¯æ›´æ–°
                        fetchData();
                    } catch (e) {
                        alert(`åˆªé™¤å¤±æ•—ï¼š${e.message}`);
                        // ç™¼ç”ŸéŒ¯èª¤å‰‡é‚„åŸæœ¬åœ°è³‡æ–™
                        allNotes.value = originalNotes;
                        localStorage.setItem(cacheKey, JSON.stringify(allNotes.value));
                        isSyncing.value = false;
                    }
                };

                // â”€â”€ æŠ“å–æœ€æ–°è³‡æ–™ â”€â”€
                const fetchData = () => {
                    isSyncing.value = true;
                    const currentVersion = ++fetchVersion; // ç´€éŒ„ç•¶ä¸‹ç™¼å‡ºè«‹æ±‚çš„ç‰ˆæœ¬è™Ÿ
                    const cacheKey = `notes_cache_${targetIdRef.value}`;

                    callApi('getNotes')
                        .then(data => {
                            // ğŸ’¡ é˜²å‘†æ©Ÿåˆ¶ï¼šå¦‚æœé€™æ®µæœŸé–“å…§ä½¿ç”¨è€…æœ‰æŒ‰åˆªé™¤(fetchVersionè¢«æ”¹è®Š)ï¼Œé€™åŒ…å›å‚³çš„èˆŠè³‡æ–™å°±å¿…é ˆä¸Ÿæ£„ï¼
                            if (currentVersion === fetchVersion) {
                                allNotes.value = data.notes || [];
                                localStorage.setItem(cacheKey, JSON.stringify(data.notes));
                                state.value = 'ready'; // è§£é™¤ Loading ç‹€æ…‹
                                isSyncing.value = false;
                            }
                        })
                        .catch(err => {
                            if (currentVersion === fetchVersion) {
                                if (state.value === 'loading') {
                                    errorMsg.value = `è¼‰å…¥å¤±æ•—ï¼š${err.message}`;
                                    state.value = 'error';
                                }
                                isSyncing.value = false;
                            }
                            console.error('GAS API æ‹‰å–éŒ¯èª¤:', err);
                        });
                };

                // â”€â”€ åˆå§‹åŒ– LIFF ä¸¦è¼‰å…¥è³‡æ–™ â”€â”€
                onMounted(async () => {
                    // ğŸ’¡ çµ‚æ¥µæ•ˆèƒ½å„ªåŒ– 1ï¼šå…ˆæ–¬å¾Œå¥ï¼åœ¨ init å‰ç›´æ¥å¾ç¶²å€è§£æ ownerId (è™•ç† LINE è½‰å€èˆ‡ liff.state)
                    let earlyOwnerId = null;
                    try {
                        const urlParams = new URLSearchParams(window.location.search);
                        earlyOwnerId = urlParams.get('ownerId');
                        if (!earlyOwnerId) {
                            const liffState = urlParams.get('liff.state');
                            if (liffState) {
                                const stateParams = new URLSearchParams(liffState);
                                earlyOwnerId = stateParams.get('ownerId');
                            }
                        }

                        // ğŸ’¡ çµ‚æ¥µæ•ˆèƒ½å„ªåŒ– 2ï¼šæœ‰äº† IDï¼Œç›´æ¥åœ¨ 0 æ¯«ç§’æ™‚æ‹¿å‡ºå¿«å–ä¸¦è§£é™¤ Loading ç•«é¢ï¼
                        if (earlyOwnerId) {
                            const cacheKey = `notes_cache_${earlyOwnerId}`;
                            const cachedData = localStorage.getItem(cacheKey);
                            if (cachedData) {
                                allNotes.value = JSON.parse(cachedData);
                                state.value = 'ready'; // ç•«é¢ç¬é–“ç§’é–‹ !!!
                            }
                        }
                    } catch (e) {
                        console.warn('ææ—©è®€å–å¿«å–å¤±æ•—', e);
                    }

                    try {
                        await liff.init({ liffId: LIFF_ID });

                        if (!liff.isLoggedIn()) {
                            liff.login();
                            return;
                        }

                        const context = liff.getContext();
                        let targetId = earlyOwnerId || '';

                        // è¬ä¸€ç¶²å€çœŸçš„æ²’æœ‰å¸¶åƒæ•¸ï¼Œæ‰é€€å›èˆŠç‰ˆæ©Ÿåˆ¶æŸ¥ context
                        if (!targetId) {
                            if (context && (context.type === 'group' || context.type === 'room')) {
                                targetId = context.groupId || context.roomId;
                            } else {
                                targetId = liff.getDecodedIDToken()?.sub || 'unknown'; // ç›´æ¥è§£ payload æ‹¿ userID é˜²å‘†
                            }

                            // é€™è£¡å†è£œæŠ“ä¸€æ¬¡å¿«å–ï¼Œå› ç‚ºé€™æ˜¯ç¬¬ä¸€æ™‚é–“æ²’æœ‰ earlyOwnerId çš„å‚™æ¡ˆ
                            const cacheKey = `notes_cache_${targetId}`;
                            const cachedData = localStorage.getItem(cacheKey);
                            if (cachedData && state.value !== 'ready') {
                                try {
                                    allNotes.value = JSON.parse(cachedData);
                                    state.value = 'ready';
                                } catch (e) { }
                            }
                        }

                        targetIdRef.value = targetId;
                        userDisplayName.value = targetId.startsWith('C') || targetId.startsWith('R') ? 'ç¾¤çµ„' : 'ä½¿ç”¨è€…';

                        // å‘¼å« GAS API å–å¾—æœ€æ–°ç­†è¨˜ (SWR æ©Ÿåˆ¶ï¼ŒèƒŒæ™¯åŸ·è¡Œ)
                        fetchData();

                        // ğŸ’¡ çµ‚æ¥µæ•ˆèƒ½å„ªåŒ– 3ï¼šæŠŠè€—æ™‚çš„ liff.getProfile æ”¾åˆ°æœ€å¾ŒéåŒæ­¥è™•ç†ï¼Œä¸é˜»ç¤™æŠ“è³‡æ–™ï¼
                        liff.getProfile().then(profile => {
                            if (!targetId.startsWith('C') && !targetId.startsWith('R')) {
                                userDisplayName.value = profile.displayName;
                            }
                        }).catch(e => console.warn('æŠ“å–å€‹äººè³‡æ–™å¤±æ•—æˆ–é­é™åˆ¶:', e));

                    } catch (err) {
                        errorMsg.value = `åˆå§‹åŒ–å¤±æ•—ï¼š${err.message}`;
                        state.value = 'error';
                        console.error('LIFF åˆå§‹åŒ–éŒ¯èª¤:', err);
                    }
                });

                return {
                    state, errorMsg, userDisplayName,
                    allNotes, mainTags, subTags,
                    activeMain, activeSub,
                    displayedNotes, filteredBySearch,
                    searchQuery, subSearchQuery, selectMain,
                    onDeleteNote, targetIdRef, isSyncing
                };
            }
        });

        app.mount('#app');
    </script>
</body>

</html>
